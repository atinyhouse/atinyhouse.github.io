#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ä¿®å¤ thoughts æ•°æ®çš„æ ¼å¼é—®é¢˜ï¼š
1. åˆ é™¤çœŸæ­£é‡å¤çš„å†…å®¹ï¼ˆ8æœˆ31ï¼‰
2. ä»æºæ•°æ®æ¢å¤10æœˆ16æ—¥çš„æ®µè½æ ¼å¼
"""

import yaml
import re
from datetime import datetime

print("="*60)
print("ğŸ”§ ä¿®å¤ Thoughts æ•°æ®æ ¼å¼")
print("="*60)
print()

# è¯»å–å½“å‰æ•°æ®
with open('_data/thoughts.yml', 'r', encoding='utf-8') as f:
    lines = []
    for line in f:
        if not line.strip().startswith('#'):
            lines.append(line)
    thoughts = yaml.safe_load(''.join(lines)) or []

print(f"å½“å‰æ•°æ®: {len(thoughts)} æ¡")
print()

# 1. åˆ é™¤8æœˆ31æ—¥çš„é‡å¤æ¡ç›®
print("ğŸ—‘ï¸  åˆ é™¤é‡å¤å†…å®¹...")
thoughts_fixed = []
removed_count = 0

for t in thoughts:
    # åˆ é™¤8æœˆ31æ—¥çš„æ¡ç›®ï¼ˆä¿ç•™9æœˆ1æ—¥ï¼‰
    if t.get('date') == '2025-08-31' and t.get('time') == '16:09':
        print(f"  âœ— åˆ é™¤: {t.get('date')} {t.get('time')} (ä¸9æœˆ1æ—¥é‡å¤)")
        removed_count += 1
        continue

    thoughts_fixed.append(t)

print(f"âœ“ åˆ é™¤äº† {removed_count} æ¡é‡å¤")
print()

# 2. æ¢å¤10æœˆ16æ—¥çš„æ®µè½æ ¼å¼
print("ğŸ“ æ¢å¤10æœˆ16æ—¥çš„æ®µè½æ ¼å¼...")

# åŸå§‹å†…å®¹ï¼ˆä»å³åˆ»è·å–çš„æ­£ç¡®æ ¼å¼ï¼‰
oct16_formatted = """æ˜¨å¤©æ™šä¸Šï¼Œç¡å‰åˆ·çŸ­è§†é¢‘çš„æ—¶å€™ï¼Œçœ‹åˆ°ä¸€ä¸ªè§†é¢‘æ˜¯ä¸€å¼ å†™æ»¡ç­”æ¡ˆçš„æ•°å­¦è€ƒå·ï¼Œæœ‰ä¸€å¥æ–‡æ¡ˆï¼š

"å°‘å¥³æ—¶ä»£çš„æ·¤é’ï¼Œ
äº§ç”Ÿäºæ·±å¤œçš„è‡ªæˆ‘æ€€ç–‘ï¼Œ
ä¸ºä»€ä¹ˆä¸èªæ˜ã€‚"

çªç„¶æ„Ÿè§‰æœ‰ç‚¹è¢«æ‰“åŠ¨ï¼Œçœ¼çœ¶æ¹¿æ¶¦ã€‚å¯èƒ½æ˜¯ç”±äºå®¶é‡Œè¿˜æœ‰ä¸€ä¸ªé«˜ä¸­ç”Ÿçš„å¦¹å¦¹ï¼Œæˆ‘ä¹Ÿæ„Ÿè§‰è‡ªå·±å¥½åƒè¿˜æ²¡æœ‰èµ°å‡ºé«˜ä¸­ç”Ÿæ´»çš„æ¼©æ¶¡ã€‚

å¦¹å¦¹å’Œæˆ‘ä¸€æ ·ï¼Œé€‰æ‹©äº†æ–‡ç§‘ã€‚åœ¨åˆ†ç§‘å‰ï¼Œå¥¹åº¦è¿‡äº†ç›¸å½“è‰°éš¾çš„ä¸€æ®µæ—¶é—´ã€‚æ˜¯å¬ä¸æ‡‚çš„ç‰©ç†è¯¾ï¼Œè·Ÿä¸ä¸ŠèŠ‚å¥çš„æ•°å­¦è¯¾ï¼Œæ˜¯å¾ˆå¤šæ¬¡æ‹¿åˆ°æ‰‹çš„éš¾ä»¥ç½®ä¿¡çš„åˆ†æ•°ã€‚ä¸çŸ¥é“å“­äº†å¤šå°‘æ¬¡ã€ç°å¿ƒä¸§æ°”äº†å¤šå°‘æ¬¡ã€‚

å³ä½¿å¾ˆå¤šäººè¯´ç†ç§‘æ›´å¥½é€‰ä¸“ä¸šã€æ›´å¥½å°±ä¸šï¼Œå³ä½¿å¤§éƒ¨åˆ†å¥¹çš„åŒå­¦éƒ½é€‰æ‹©ç†ç§‘ï¼Œå³ä½¿é€‰äº†æ–‡ç§‘ç­ä¼šè¢«æ‰“ä¸Šæ²¡é‚£ä¹ˆèªæ˜çš„æ ‡ç­¾ï¼Œå¥¹è¿˜æ˜¯å¾ˆåšå†³åœ°é€‰äº†æ–‡ç§‘ã€‚

è¿›å…¥æ–‡ç§‘ç­ä¹‹åï¼Œå¥¹çŠ¶æ€å¥½äº†å¾ˆå¤šã€‚ä¸ç”¨å†ä¸Šç‰©ç†è¯¾äº†ï¼Œä¹Ÿæœ‰æ›´å¤šæ—¶é—´å­¦ä¹ æ•°å­¦ã€‚

æ¯å¤©æ™šä¸Šå¤§æ¦‚åäºŒç‚¹å·¦å³çš„æ—¶å€™ï¼Œå¥¹éƒ½ä¼šç»™æˆ‘å‘ä¿¡æ¯ã€‚ä¸»è¦æ˜¯ç»™æˆ‘æ‹ç…§ç‰‡ï¼Œæ™šè‡ªä¹ ç»“æŸåï¼Œå¥¹å›åˆ°å°å°çš„æˆ¿é—´é‡Œï¼Œåˆå­¦ä¹ äº†ä»€ä¹ˆã€‚å¾ˆè®¤çœŸã€å¾ˆè¸å®çš„å¦¹å¦¹ã€‚

æˆ‘ä¹Ÿé€šå¸¸ä¼šå‘ä¸€ä¸¤å¥ç±»ä¼¼äº"æ£’æ£’å“’ã€è¾›è‹¦äº†"ä¹‹ç±»çš„è¯é¼“åŠ±å¥¹ã€‚é«˜ä¸­çš„æ•°å­¦æˆ‘å½“ç„¶å·²ç»å‡ ä¹å…¨éƒ¨å¿˜å…‰ï¼Œæˆ‘æ‰€èƒ½å¸®åŠ©å¥¹çš„ä¹Ÿåªæ˜¯ç»™å¥¹é¼“åŠ±å’Œå®‰æ…°è€Œå·²ã€‚

åªä¸è¿‡çœ‹åˆ°å¥¹æ¯ä¸€å¤©çš„æ·±å¤œéƒ½å‘ç»™æˆ‘çš„é¢˜ç›®ç…§ç‰‡ï¼Œæˆ‘ä¸‹æ„è¯†åœ°å°±ä¼šæµ®ç°å‡ºï¼Œè¿œåœ¨åƒé‡Œä¹‹å¤–çš„æ­¤æ—¶æ­¤åˆ»ï¼Œåœ¨åªæœ‰é’æ˜¥æœŸæ‰ä¼šäº®èµ·çš„å°ç¯ä¸‹é¢ï¼Œå¥¹åœ¨ä½ç€å¤´è®¤çœŸçš„æ€è€ƒã€åšé¢˜ã€‚

ä¸çŸ¥é“å¥¹æ˜¯å¦ä¹Ÿä¼šåƒè¿™ä¸ªä¿—å¥—æ–‡æ¡ˆé‡Œè¯´çš„ï¼Œè´¨ç–‘è‡ªå·±æ˜¯å¦ä¸èªæ˜ã€‚

æˆ‘å¾ˆæƒ³å‘Šè¯‰å¥¹ï¼Œæˆ‘é‚£ä¸ªæ—¶å€™ï¼Œä¹Ÿæœ‰å¾ˆå¤šé¢˜ä¸ä¼šåšï¼Œä¹Ÿå¾ˆç¾¡æ…•èº«è¾¹çš„åŒå­¦èƒ½è§£é™¤éå¸¸å¤æ‚çš„æ•°å­¦é¢˜ï¼Œæˆ‘ä¹Ÿè§‰å¾—è‡ªå·±æ²¡æœ‰é‚£ä¹ˆèªæ˜ã€‚æˆ‘åå¤çš„åœ¨æ­¤åçš„äººç”Ÿç”¨å„ç§æƒ…å½¢æ¥éªŒè¯è‡ªå·±æ˜¯å¦è¶³å¤Ÿèªæ˜ã€è¶³å¤Ÿå¤Ÿæ ¼ã€‚

å¯æ˜¯æˆ‘ç°åœ¨è§‰å¾—å¥½åƒæ˜¯å¦èªæ˜çœŸçš„ä¸é‡è¦ï¼ŒåŠªåŠ›çš„è¿‡ç¨‹å¾ˆé‡è¦ï¼Œé‡åˆ°å›°éš¾äº§ç”Ÿçš„ä¿¡å¿ƒå’ŒéŸ§æ€§å¾ˆé‡è¦ï¼Œå¯¹ç”Ÿæ´»çš„è½»æ¾æ„‰å¿«çš„å¿ƒæƒ…å¾ˆé‡è¦ã€‚

å°‘å¥³æ—¶ä»£çš„æ·¤é’åªæ˜¯æˆé•¿çš„ä¸€ä¸ªæ³¨è„šï¼Œæ·¤é’æ€»æœ‰ä¸€å¤©ä¼šæ¶ˆå¤±çš„ï¼Œå’Œå°‘å¥³æ—¶ä»£ä¸€èµ·ã€‚"""

# æ›¿æ¢10æœˆ16æ—¥çš„å†…å®¹
for t in thoughts_fixed:
    if t.get('date') == '2025-10-16' and t.get('time') == '04:20':
        old_len = len(t.get('content', ''))
        t['content'] = oct16_formatted
        new_len = len(t['content'])
        print(f"  âœ“ æ›´æ–°: {t.get('date')} {t.get('time')}")
        print(f"    åŸé•¿åº¦: {old_len} -> æ–°é•¿åº¦: {new_len}")
        print(f"    æ®µè½æ•°: {t['content'].count(chr(10) + chr(10)) + 1}")

print()

# 3. ä¿å­˜
print("ğŸ’¾ ä¿å­˜ä¿®å¤åçš„æ•°æ®...")

thoughts_fixed.sort(
    key=lambda x: (x.get('date', '0000-00-00'), x.get('time', '00:00')),
    reverse=True
)

header = f"""# ============================================
# Thoughts æ•°æ®æ–‡ä»¶ - å³åˆ»åŠ¨æ€
# ============================================
#
# å·²ä¿®å¤ï¼šåˆ é™¤é‡å¤ã€æ¢å¤æ®µè½æ ¼å¼
# ä¿®å¤æ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
#
# ============================================

"""

with open('_data/thoughts.yml', 'w', encoding='utf-8') as f:
    f.write(header)
    yaml.dump(
        thoughts_fixed,
        f,
        allow_unicode=True,
        sort_keys=False,
        default_flow_style=False,
        width=float('inf')
    )

print("âœ“ ä¿å­˜å®Œæˆ")
print()

print("="*60)
print("âœ… ä¿®å¤å®Œæˆï¼")
print("="*60)
print()
print(f"ğŸ“Š ç»Ÿè®¡:")
print(f"  - åŸå§‹æ•°æ®: {len(thoughts)} æ¡")
print(f"  - åˆ é™¤é‡å¤: {removed_count} æ¡")
print(f"  - æœ€ç»ˆæ•°æ®: {len(thoughts_fixed)} æ¡")
print()
